# EduTrack AI 設計書（最終版）

## 概要

**アプリ名**: EduTrack AI  
**概要**: オンライン教師向けの出席管理・成績記録・AIフィードバック支援アプリ  
**主な機能**: 教師/管理者の認証、生徒管理、出席・成績の記録、AIによる保護者向けフィードバック文の生成・保存・メール送信  
**ロール**: `teacher`（教師）, `admin`（管理者）  
**技術スタック**: Next.js（App Router）, Supabase（Auth + DB）, **Gemini API（Google）**, Resend（メール）, Tailwind CSS, React Bootstrap

---

## 1. DB設計

### 1.1 テーブル一覧（ERの代わりにテーブル定義）

Supabase 利用を前提に、`types/index.ts` と API/画面の使われ方に合わせた定義。

| 論理名 | 物理名 | 説明 |
|--------|--------|------|
| ユーザー（教師/管理者） | `profiles` | Auth と 1:1。ロール・表示名を保持 |
| 生徒 | `students` | 教師に紐づく生徒マスタ |
| **授業** | **`lessons`** | **授業スケジュール（日時・担当教師・タイトル）。管理者が登録・削除、教師は担当分のみ閲覧** |
| 出席 | `attendances` | 生徒・日付（lesson_date）・出欠ステータス。1日1レコード。授業画面では `lessons.lesson_at` の日付で紐づけ |
| 成績 | `grades` | 生徒・テスト名・得点・日付 |
| フィードバック | `feedbacks` | 生徒向けAIフィードバック文・送信状態 |

※ Supabase Auth の `auth.users` はそのまま利用し、アプリ用の拡張は `profiles` に集約する想定。  
※ **`profiles` テーブルは `auth.users` の INSERT トリガー（`handle_new_user`）で自動作成される。**  
※ **出席（attendances）は「日」単位で `lesson_date` を持つ。授業（lessons）は日時（`lesson_at`）を持つ。授業詳細画面では `lesson_at` の日付部分（YYYY-MM-DD）を `lesson_date` として出席登録に使用する。**

### 1.2 テーブル定義（カラム・型・制約）

#### profiles（Auth 連携）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|----------|-----|------|------------|------|
| id | uuid | NO | - | PK, `auth.users.id` と一致 |
| name | text | NO | - | 表示名 |
| email | text | NO | - | メール（auth.users と同期想定） |
| role | text | NO | 'teacher' | 'teacher' \| 'admin'（CHECK制約あり） |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時（自動更新） |

- **CHECK制約**: `role IN ('teacher', 'admin')`
- **RLS**: 自レコードの読み取り・更新のみ許可（管理者は全件参照用ポリシーを別途検討）
- **作成方法**: `auth.users` の INSERT トリガー（`handle_new_user`）で自動作成

#### students

| カラム名 | 型 | NULL | デフォルト | 説明 |
|----------|-----|------|------------|------|
| id | uuid | NO | gen_random_uuid() | PK |
| name | text | NO | - | 生徒氏名 |
| grade_level | text | YES | - | 学年（例: 中3, 高1） |
| teacher_id | uuid | YES | - | FK → profiles.id（ON DELETE SET NULL） |
| student_email | text | YES | - | 生徒用メール |
| parent_email | text | YES | - | 保護者メール（フィードバック送信先） |
| memo | text | YES | - | 備考 |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時（自動更新） |

- **外部キー制約**: `teacher_id` → `profiles.id` ON DELETE SET NULL
- **RLS**: 教師は `teacher_id = auth.uid()` の行のみ、管理者は全件（別ポリシーで実装）
- **設計意図**: `teacher_id` は NULL 許容。未割り当て生徒は管理者のみ表示（教師ダッシュボードには表示しない）

#### attendances

| カラム名 | 型 | NULL | デフォルト | 説明 |
|----------|-----|------|------------|------|
| id | uuid | NO | gen_random_uuid() | PK |
| student_id | uuid | NO | - | FK → students.id（ON DELETE CASCADE） |
| lesson_date | date | NO | - | 授業日 |
| status | text | NO | - | 'present' \| 'absent' \| 'late'（CHECK制約あり） |
| memo | text | YES | - | 備考 |
| created_at | timestamptz | NO | now() | 作成日時 |

- **CHECK制約**: `status IN ('present', 'absent', 'late')`
- **外部キー制約**: `student_id` → `students.id` ON DELETE CASCADE
- **ユニーク制約**: `(student_id, lesson_date)` で 1 日 1 レコード（オンライン家庭教師の場合、一日1回の授業が多いため）
- **RLS**: 対応する `students` の `teacher_id` が自ユーザー（または管理者）のときのみアクセス可能とする想定

#### lessons（授業スケジュール）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|----------|-----|------|------------|------|
| id | uuid | NO | gen_random_uuid() | PK |
| teacher_id | uuid | NO | - | FK → profiles.id（ON DELETE CASCADE）。担当教師 |
| lesson_at | timestamptz | NO | - | 授業日時（ISO 8601） |
| title | text | YES | - | 授業タイトル（任意） |
| created_at | timestamptz | NO | now() | 作成日時 |

- **外部キー制約**: `teacher_id` → `profiles.id` ON DELETE CASCADE
- **RLS**: 管理者は全件操作可（SELECT/INSERT/UPDATE/DELETE）。教師は `teacher_id = auth.uid()` の行のみ SELECT 可能（登録・削除は管理者のみ）
- **設計意図**: 管理者が授業を登録・削除。教師・管理者はダッシュボードのカレンダーで閲覧。教師は担当授業のみ表示。出席は `attendances` の `lesson_date` で管理し、授業画面では `lesson_at` の日付部分（YYYY-MM-DD）を `lesson_date` として出席登録に使用する
- **インデックス**: `idx_lessons_lesson_at`, `idx_lessons_teacher_id`（TABLE.md 準拠）

#### grades

| カラム名 | 型 | NULL | デフォルト | 説明 |
|----------|-----|------|------------|------|
| id | uuid | NO | gen_random_uuid() | PK |
| student_id | uuid | NO | - | FK → students.id（ON DELETE CASCADE） |
| test_name | text | NO | - | テスト名 |
| score | int | NO | - | 得点 |
| max_score | int | NO | - | 満点 |
| comment | text | YES | - | コメント |
| test_date | date | NO | - | 受験日 |
| created_at | timestamptz | NO | now() | 作成日時 |

- **外部キー制約**: `student_id` → `students.id` ON DELETE CASCADE
- **CHECK制約**: `score <= max_score`（TABLE.md 準拠）
- **RLS**: attendances と同様、生徒の担当教師（または管理者）のみアクセス可

#### feedbacks

| カラム名 | 型 | NULL | デフォルト | 説明 |
|----------|-----|------|------------|------|
| id | uuid | NO | gen_random_uuid() | PK |
| student_id | uuid | NO | - | FK → students.id（ON DELETE CASCADE） |
| content | text | NO | - | フィードバック本文 |
| sent | boolean | NO | false | 送信済みフラグ |
| sent_at | timestamptz | YES | - | 送信日時 |
| send_to_email | text | YES | - | 送信先メールアドレス（トレーサビリティ確保）。コード・TABLE.md では `send_to_email` |
| created_by | uuid | NO | - | FK → profiles.id（ON DELETE RESTRICT） |
| created_at | timestamptz | NO | now() | 作成日時 |

- **外部キー制約**: 
  - `student_id` → `students.id` ON DELETE CASCADE
  - `created_by` → `profiles.id` ON DELETE RESTRICT（作成者の削除は禁止）
- **RLS**: 対応する生徒の担当教師（または管理者）のみアクセス可

### 1.3 ER（関係）の要約

- `profiles` ←── `students`（teacher_id, ON DELETE SET NULL）
- **`profiles` ←── `lessons`（teacher_id, ON DELETE CASCADE）**
- `students` ←── `attendances`, `grades`, `feedbacks`（student_id, ON DELETE CASCADE）
- `profiles` ←── `feedbacks`（created_by, ON DELETE RESTRICT）
- **論理的な紐づけ**: `attendances.lesson_date` と `lessons.lesson_at` の日付部分（YYYY-MM-DD）で対応。lessons テーブルへの FK は持たない。

### 1.4 RLSポリシー（具体SQL例）

#### profiles

```sql
-- 自レコードの読み取り
CREATE POLICY "profiles_select_own" ON profiles
  FOR SELECT USING (auth.uid() = id);

-- 自レコードの更新
CREATE POLICY "profiles_update_own" ON profiles
  FOR UPDATE USING (auth.uid() = id);

-- 管理者は全件読み取り可能（必要に応じて）
CREATE POLICY "profiles_select_admin" ON profiles
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin'
    )
  );
```

#### students

```sql
-- 教師は担当生徒のみ読み取り
CREATE POLICY "students_select_teacher" ON students
  FOR SELECT USING (
    teacher_id = auth.uid() OR
    EXISTS (
      SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin'
    )
  );

-- 教師は担当生徒のみ更新
CREATE POLICY "students_update_teacher" ON students
  FOR UPDATE USING (
    teacher_id = auth.uid() OR
    EXISTS (
      SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin'
    )
  );
```

#### attendances / grades

```sql
-- 教師は担当生徒のデータのみ読み取り
CREATE POLICY "attendances_select_teacher" ON attendances
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM students 
      WHERE students.id = attendances.student_id 
      AND (students.teacher_id = auth.uid() OR
           EXISTS (
             SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin'
           ))
    )
  );

-- grades も同様のポリシーを適用
```

#### lessons

```sql
-- 管理者: 全操作可（is_admin() を使用）
CREATE POLICY "Admins can do everything on lessons"
  ON lessons FOR ALL
  USING (public.is_admin())
  WITH CHECK (public.is_admin());

-- 教師: 自分が担当の授業のみ SELECT
CREATE POLICY "Teachers can view own lessons"
  ON lessons FOR SELECT
  USING (teacher_id = auth.uid());
```

---

## 2. API設計

### 2.1 CRUD操作の実装方針

| リソース | 操作 | 実装方法 | 理由 |
|----------|------|----------|------|
| **profiles** | 一覧取得 | Supabase直接 | 管理者画面のみ。RLSで制御 |
| **profiles** | 詳細取得 | Supabase直接 | 認証情報取得と同時 |
| **profiles** | 作成 | **Supabase Auth + Database Trigger** | **サインアップ時に `auth.users` の INSERT トリガーで自動作成** |
| **profiles** | 更新 | Supabase直接 | プロフィール編集はシンプルなため |
| **students** | 一覧取得 | Supabase直接 | RLSで担当生徒のみ取得可能 |
| **students** | 詳細取得 | Supabase直接 | RLSで制御 |
| **students** | 作成 | Supabase直接 | 管理者/教師が作成。RLSで制御 |
| **students** | 更新 | Supabase直接 | RLSで制御 |
| **students** | 削除 | Supabase直接 | RLSで制御（CASCADEで関連データも削除） |
| **attendances** | 一覧取得 | Supabase直接 | 生徒詳細画面で取得。RLSで制御 |
| **attendances** | 登録・更新 | **API経由** | POST /api/attendances（upsert。student_id + lesson_date で一意） |
| **attendances** | 削除 | Supabase直接 | RLSで制御（APIは未実装） |
| **grades** | 一覧取得 | Supabase直接 | 生徒詳細画面で取得。RLSで制御 |
| **grades** | 登録 | **API経由** | POST /api/grades（担当生徒のみ） |
| **grades** | 更新・削除 | Supabase直接 | RLSで制御（APIは未実装） |
| **lessons** | 一覧取得 | **API経由** | GET /api/lessons?month=YYYY-MM。教師は担当のみ、管理者は全件 |
| **lessons** | 1件取得 | **API経由** | GET /api/lessons/[id] |
| **lessons** | 登録 | **API経由** | POST /api/lessons（管理者のみ） |
| **lessons** | 削除 | **API経由** | DELETE /api/lessons/[id]（管理者のみ） |
| **feedbacks** | 一覧取得 | Supabase直接 | 生徒詳細画面で取得。RLSで制御 |
| **feedbacks** | 作成 | **API経由** | AI生成後の保存処理を統一 |
| **feedbacks** | 生成 | **API経由** | **Gemini API連携が必要なため** |
| **feedbacks** | 送信 | **API経由** | **Resendメール送信処理を統一** |

**方針の根拠**:
- **Supabase直接**: RLSで権限制御可能なシンプルなCRUDは直接アクセスで十分
- **API経由**: 外部サービス連携（**Gemini API**、Resend）や複雑な処理が必要な場合

### 2.2 エンドポイント一覧

| メソッド | パス | 概要 | 認証 |
|----------|------|------|------|
| GET | `/api/lessons?month=YYYY-MM` | 授業一覧（教師=担当のみ / 管理者=全件） | 要 |
| POST | `/api/lessons` | 授業登録（管理者のみ） | 要 |
| GET | `/api/lessons/[id]` | 授業1件取得（教師は自分の授業のみ） | 要 |
| DELETE | `/api/lessons/[id]` | 授業削除（管理者のみ） | 要 |
| POST | `/api/attendances` | 出席の upsert（student_id, lesson_date, status, memo） | 要 |
| POST | `/api/grades` | 成績の追加（student_id, test_name, score, max_score, test_date 等） | 要 |
| POST | `/api/feedback` | フィードバック保存 | 要 |
| POST | `/api/feedback/generate` | **Gemini APIによる**AIフィードバック文生成 | 要 |
| POST | `/api/feedback/[id]/send` | **Resendによる**フィードバックメール送信 | 要 |

※ 生徒一覧・生徒詳細・出席一覧・成績一覧・フィードバック一覧は Supabase から直接（RLS 付き）取得。

### 2.3 リクエスト / レスポンス定義

#### POST /api/feedback

フィードバックの保存（LLM で生成した content の登録）。

**Request**
- Body (JSON): `{ "student_id": string (uuid), "content": string }`

**Response**
- `201`: `{ "id": string (uuid) }`
- `400`: `{ "error": { "code": "VALIDATION_ERROR", "message": string } }`
- `401`: `{ "error": { "code": "UNAUTHORIZED" } }`
- `500`: `{ "error": { "code": "INTERNAL_ERROR", "message": string } }`

#### POST /api/feedback/generate

指定生徒の出席・成績を元に **Gemini API** で AI フィードバック文を生成。

**Request**
- Body (JSON): `{ "student_id": string (uuid) }`

**Response**
- `200`: `{ "content": string }`
- `400`: `{ "error": { "code": "VALIDATION_ERROR", "message": string } }`
- `401`: `{ "error": { "code": "UNAUTHORIZED" } }`
- `404`: `{ "error": { "code": "STUDENT_NOT_FOUND" } }`（生徒が存在しない or 権限なし）
- `500`: `{ "error": { "code": "GENERATION_FAILED", "message": string } }`

#### POST /api/feedback/[id]/send

指定フィードバックを保護者メールに送信（**Resend API**使用）し、送信状態を更新。

**Request**
- Path: `id` = feedback の uuid
- Body: なし（または空オブジェクト）

**Response**
- `200`: `{ "ok": true }`
- `401`: `{ "error": { "code": "UNAUTHORIZED" } }`
- `404`: `{ "error": { "code": "FEEDBACK_NOT_FOUND" } }`
- `400`: `{ "error": { "code": "NO_PARENT_EMAIL", "message": string } }`（保護者メール未設定）
- `500`: `{ "error": { "code": "SEND_FAILED", "message": string } }`

#### GET /api/lessons?month=YYYY-MM

指定月の授業一覧。教師は担当授業のみ、管理者は全件。

**Response**: `200` → `{ "lessons": Array<{ id, lesson_at, teacher_id, title, created_at }> }`

#### POST /api/lessons（管理者のみ）

**Request**: Body `{ "lesson_at": string (ISO 8601), "teacher_id": string (uuid), "title"?: string }`  
**Response**: `201` → 登録された lesson オブジェクト。`403` 教師は不可。

#### GET /api/lessons/[id]

**Response**: `200` → lesson 1件。`404` 存在しない / `403` 権限なし。

#### DELETE /api/lessons/[id]（管理者のみ）

**Response**: `204` 成功。`403` 教師は不可。

#### POST /api/attendances

出席の upsert（student_id + lesson_date で一意）。

**Request**: Body `{ "student_id": uuid, "lesson_date": "YYYY-MM-DD", "status": "present"|"absent"|"late", "memo"?: string }`  
**Response**: `200` → `{ "id", "student_id", "lesson_date", "status", "memo" }`。`404` 生徒なし / `403` 権限なし。

#### POST /api/grades

成績の追加。

**Request**: Body `{ "student_id", "test_name", "score", "max_score", "test_date" (YYYY-MM-DD), "comment"?: string }`  
**Response**: `201` → 登録された grade オブジェクト。`404` 生徒なし / `403` 権限なし。

---

## 3. ディレクトリ構成

```
EduTrack AI/
├── app/
│   ├── api/                    # API Route層（REST 入口）
│   │   ├── attendances/
│   │   │   └── route.ts        # POST: 出席 upsert
│   │   ├── feedback/
│   │   │   ├── route.ts        # POST: フィードバック保存
│   │   │   ├── generate/
│   │   │   │   └── route.ts    # POST: Gemini APIによるAI生成
│   │   │   └── [id]/send/
│   │   │       └── route.ts   # POST: Resendによるメール送信
│   │   ├── grades/
│   │   │   └── route.ts        # POST: 成績追加
│   │   └── lessons/
│   │       ├── route.ts        # GET: 月別一覧 / POST: 登録（admin）
│   │       └── [id]/route.ts  # GET: 1件取得 / DELETE: 削除（admin）
│   ├── auth/
│   │   ├── login/page.tsx      # ログイン画面
│   │   └── signup/page.tsx    # サインアップ画面
│   ├── dashboard/
│   │   ├── layout.tsx         # ダッシュボード共通レイアウト（Navbar, Container）
│   │   ├── page.tsx           # トップ（統計）
│   │   ├── admin/page.tsx     # 管理者メニュー（教師一覧・生徒追加・授業追加等）
│   │   ├── calendar/page.tsx  # カレンダー画面（月別授業一覧）
│   │   ├── lessons/
│   │   │   └── [id]/page.tsx  # 授業詳細（出席登録フォーム）
│   │   └── students/
│   │       ├── page.tsx        # 生徒一覧
│   │       └── [id]/page.tsx  # 生徒詳細（出席・成績・フィードバック）
│   ├── globals.css
│   ├── layout.tsx
│   └── page.tsx               # ランディング/未認証トップ
├── components/
│   ├── admin/
│   │   ├── TeacherTable.tsx   # 教師一覧（管理者用）
│   │   ├── AddStudentForm.tsx # 生徒追加フォーム
│   │   └── AddLessonForm.tsx  # 授業追加・一覧・削除（管理者用）
│   ├── dashboard/
│   │   └── CalendarView.tsx   # 月別カレンダー（授業リンク）
│   ├── lessons/
│   │   └── LessonAttendanceForm.tsx # 授業日付に紐づく出席登録
│   ├── students/
│   │   ├── StudentTable.tsx   # 生徒一覧テーブル
│   │   ├── AttendanceList.tsx # 出席履歴
│   │   ├── GradeList.tsx      # 成績履歴・成績追加フォーム
│   │   ├── AddGradeForm.tsx   # 成績追加フォーム
│   │   └── FeedbackPanel.tsx  # AIフィードバック生成・保存・送信UI
│   ├── DashboardStats.tsx     # ダッシュボード統計カード
│   ├── DashboardNavbar.tsx    # ダッシュボード用ナビゲーション
│   ├── DashboardAuthGuard.tsx # 認証ガード（未ログイン時リダイレクト）
│   └── LogoutButton.tsx       # ログアウトボタン
├── lib/
│   ├── auth.ts                # 認証ヘルパー（requireAuth 等）
│   ├── constants.ts           # ロール・出席ステータス等の定数
│   ├── email.ts               # メール送信（Resend）
│   ├── gemini.ts              # Gemini API フィードバック生成
│   ├── supabase.ts            # ブラウザ用 Supabase クライアント
│   ├── supabase-server.ts     # サーバー側専用 Supabase クライアント
│   ├── profile.ts             # プロフィール取得（getCurrentProfile）
│   └── validators.ts          # 入力バリデーション
├── types/
│   └── index.ts               # Profile, Student, Attendance, Grade, Lesson, Feedback
├── utils/
│   ├── date.ts
│   └── format.ts
├── middleware.ts
├── next.config.mjs
├── package.json
├── tailwind.config.ts
├── tsconfig.json
└── .env.local                 # 環境変数（Git管理外）
```

**各層の責務**:
- **app**: ルーティング・ページ・API の入口
- **components**: 画面単位・機能単位の UI。データ取得は Server Component または API 経由
- **lib**: Supabase・Gemini API・Resend・認証・プロフィール・定数・バリデーション
- **types**: DB/API で共通利用する型（Profile, User, Student, Attendance, Grade, Lesson, Feedback）

---

## 4. 環境変数一覧

| 変数名 | 説明 | 必須 | 用途 |
|--------|------|------|------|
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase プロジェクトURL | ✅ | Supabase クライアント初期化 |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase 匿名キー | ✅ | Supabase クライアント初期化 |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase サービスロールキー | ✅ | サーバー側での管理操作（必要に応じて） |
| `GEMINI_API_KEY` | **Google Gemini API キー** | ✅ | **AIフィードバック生成** |
| `RESEND_API_KEY` | Resend API キー | ✅ | メール送信 |
| `RESEND_FROM` | Resend送信元メールアドレス | ⚠️ | メール送信（デフォルト: `EduTrack AI <onboarding@resend.dev>`） |

---

## 5. 実装済み機能（コードベース準拠）

- ✅ ユーザー認証（Supabase Auth・ログイン・サインアップ・ログアウト）
- ✅ プロフィール自動作成（Database Trigger `handle_new_user`）
- ✅ ダッシュボード認証ガード・ナビゲーション（DashboardAuthGuard, DashboardNavbar）
- ✅ 授業（lessons）: GET/POST /api/lessons, GET/DELETE /api/lessons/[id]、カレンダー画面・授業詳細画面・授業登録（管理者）
- ✅ 出席: POST /api/attendances（upsert）、授業詳細での出席登録フォーム（LessonAttendanceForm）、生徒詳細での出席一覧
- ✅ 成績: POST /api/grades、生徒詳細での成績一覧・成績追加フォーム（AddGradeForm）
- ✅ 生徒: 一覧・詳細・追加フォーム（管理者）（Supabase 直接 + AddStudentForm）
- ✅ フィードバック: 生成API（Gemini API）・保存API・送信API（Resend）、FeedbackPanel（生成・保存・送信UI）
- ✅ ダッシュボード統計（DashboardStats：今月の出席数等）
- ✅ 教師一覧（管理者）TeacherTable

---

## 6. 今後の拡張予定

- [ ] 生徒・成績の更新・削除 API（必要に応じて）
- [ ] 出席削除 API（必要に応じて）
- [ ] ミドルウェアでの未認証リダイレクト強化
- [ ] エラーハンドリング・ローディング表示の統一
