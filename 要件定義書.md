# EduTrack AI 要件定義書（最終版）

## アプリ名

**EduTrack AI**（出席管理・成績記録アプリ / オンライン教師向け）

---

## 1. アプリの概要・目的

本アプリは、オンライン教師および教育機関向けの出席管理・成績記録・フィードバック支援Webアプリケーションである。

オンライン授業の普及により、出席管理や成績管理をスプレッドシート等で分散管理しているケースが多く、以下の課題が存在する。

- 出席記録と成績記録が分散している
- 生徒ごとの学習推移が把握しにくい
- 保護者向けフィードバック作成に時間がかかる
- 複数教師が在籍する場合、担当管理が煩雑になる

本アプリは、出席・成績・担当教師情報を一元管理し、さらに**LLM（Gemini API）を活用したフィードバック自動生成機能**を実装することで、教育業務の効率化と品質向上を実現することを目的とする。

---

## 2. ターゲットユーザー

### 2.1 教師ユーザー

- オンライン家庭教師
- 個人塾講師
- 少人数制スクール講師

### 2.2 管理者ユーザー

- 塾長
- 教室マネージャー
- 教育系スタートアップ運営者

---

## 3. ユーザー種別と権限

本アプリでは、ユーザーを以下の2種類に分ける。

### 3.1 教師ユーザー

- 自身が担当する生徒のみ閲覧・編集可能
- 出席および成績の登録・編集
- フィードバック生成および送信

### 3.2 管理者ユーザー

- 全教師データの閲覧・追加・編集・削除
- 全生徒データの閲覧・追加・編集・削除
- 生徒への担当教師割り当て・変更
- **授業（lessons）の登録・削除**（教師は担当授業の閲覧のみ）
- 全出席・成績データの閲覧
- 全体統計の閲覧

**実装方法**: Supabaseの認証機能およびRLS（Row Level Security）を用いて、ロールごとのアクセス制御を実装する。

---

## 4. 機能一覧（優先度付き）

### 4.1 必須機能

#### ユーザー認証機能

- サインアップ
- ログイン
- ログアウト
- ユーザーロール管理（教師 / 管理者）
- ロールに応じた画面制御およびデータ制御
- **プロフィール自動作成（Database Trigger）**

#### 教師管理機能（管理者のみ）

- 教師一覧表示
- 教師の新規追加
- 教師情報編集
- 教師削除

**登録項目**:
- 氏名
- メールアドレス
- ロール
- 登録日

#### 生徒管理機能

**教師ユーザー**:
- 自分の担当生徒のみ閲覧・編集可能

**管理者ユーザー**:
- 全生徒の閲覧・追加・編集・削除可能

**登録項目**:
- 氏名
- 学年
- 担当教師
- 生徒メールアドレス
- 保護者メールアドレス
- メモ
- 登録日

#### 授業スケジュール機能（lessons）

- **管理者が授業を登録・削除**（日時・担当教師・タイトルを指定）
- **月別カレンダーで授業一覧を表示**（教師は担当授業のみ、管理者は全件）
- **授業詳細画面**でその日の担当生徒に対する出席登録（出席・欠席・遅刻・メモ）
- 授業は日時（`lesson_at`）で保持。出席は「日」単位（`lesson_date`）で `attendances` に記録し、授業画面では `lesson_at` の日付部分で紐づける

**権限**: 教師は担当授業の閲覧・出席登録のみ。管理者は授業の登録・削除・全閲覧。

#### 出席管理機能（CRUD）

- 授業日ごとの出席記録（`lesson_date` = YYYY-MM-DD、1日1レコード/生徒）
- 出席、欠席、遅刻の記録
- 授業メモ記録
- 履歴一覧表示（生徒詳細画面）
- **授業詳細画面からその日の出席を一括登録**（LessonAttendanceForm）

**権限**:
- 教師は自分の担当生徒のみ編集可能
- 管理者は全データ閲覧・編集可能

#### 成績管理機能（CRUD）

- テスト名
- 得点
- 満点
- 日付
- コメント
- 履歴一覧表示

**権限**:
- 教師は自分の担当生徒のみ編集可能
- 管理者は全データ閲覧可能

#### LLM活用機能

生徒の出席状況および成績履歴をもとに、保護者向けフィードバック文章を自動生成する。

**使用API**: **Google Gemini API（gemini-2.0-flash）**

**機能内容**:
- 学習状況の要約
- 強みと課題の整理
- 次回学習提案の生成
- 生成結果の保存

#### フィードバック送信機能

- 生成したフィードバックを保護者メールアドレスへ送信
- **送信サービス**: **Resend API**
- 送信履歴の保存（`send_to_email` カラムでトレーサビリティ確保）

#### レスポンシブ対応

- PC、タブレット、スマートフォン対応

#### Vercelへのデプロイ

- 実際にアクセス可能なURLで公開

### 4.2 加点要素（任意）

- LLMストリーミングレスポンス
- 成績推移のグラフ表示
- ローディング表示およびエラーハンドリング
- RLSの厳密なロール設計
- テストコード実装
- CI/CDパイプライン構築

---

## 5. 画面一覧

### 5.1 ログイン画面

- メールアドレス
- パスワード
- ログインボタン
- 新規登録リンク

### 5.2 サインアップ画面

- 氏名
- メールアドレス
- パスワード
- 登録ボタン
- ログインリンク

### 5.3 ダッシュボード画面（トップ）

**教師ユーザー**:
- 担当生徒一覧への導線
- 今月の授業数（出席レコード数）
- 平均点等の統計

**管理者ユーザー**:
- 全生徒数
- 教師数
- 全体平均点
- 教師一覧・生徒一覧・授業登録への導線

### 5.4 カレンダー画面

- 月別で授業一覧を表示（CalendarView）
- 各日付の授業をクリックで授業詳細へ遷移
- 教師は担当授業のみ表示、管理者は全件表示

### 5.5 授業詳細画面

- 授業日時・タイトル・担当教師の表示
- その日の `lesson_date` で紐づく出席登録フォーム（LessonAttendanceForm）
- 担当生徒ごとに出席・欠席・遅刻・メモを登録・更新（POST /api/attendances で upsert）

### 5.6 生徒詳細画面（教師・管理者）

- 生徒基本情報
- 担当教師表示
- 出席履歴一覧
- 成績履歴一覧
- 出席追加
- 成績追加

### 5.7 管理者メニュー画面（管理者のみ）

- 教師一覧（TeacherTable）
- 生徒追加フォーム（AddStudentForm）
- 授業追加・一覧・削除（AddLessonForm）

### 5.8 フィードバック画面（教師用・生徒詳細内）

- **生成中表示**
- **生成文章表示**
- **保存ボタン**
- **メール送信ボタン**

---

## 6. 技術選定理由

### 6.1 Next.js（App Router）

**選定理由**:
- フロントエンドとAPIを同一プロジェクトで管理可能
- ロールごとの画面分岐および認証制御を実装しやすい
- Server Components と Client Components の使い分けが可能
- Vercel との統合が容易

### 6.2 Supabase

**選定理由**:
- 認証、データベース、RLSを統合的に利用できる
- 教師と管理者のロールに応じた厳密なアクセス制御をデータベースレベルで実装できる
- **Database Trigger によるプロフィール自動作成が可能**
- リアルタイム機能（将来拡張時）も利用可能

### 6.3 Gemini API（Google）

**選定理由**:
- **生徒データをもとに自然なフィードバック文章を生成するために利用する**
- **本アプリの中核的な付加価値機能である**
- **gemini-2.0-flash モデルは高速でコスト効率が良い**
- **日本語の自然な文章生成に優れている**

### 6.4 Resend

**選定理由**:
- **メール送信の信頼性が高い**
- **開発者向けAPIが使いやすい**
- **HTMLメールの送信が容易**
- **送信履歴の管理が可能**

### 6.5 Tailwind CSS

**選定理由**:
- 効率的なUI実装とレスポンシブ対応を可能にする
- ユーティリティファーストのアプローチで開発速度が向上
- カスタマイズが容易

### 6.6 React Bootstrap

**選定理由**:
- **Bootstrap コンポーネントを React で利用可能**
- **フォームやカードなどのUI部品が豊富**
- **Tailwind CSS と併用して使用**

### 6.7 Vercel

**選定理由**:
- Next.jsとの統合が容易
- GitHub連携による自動デプロイが可能
- 無料プランでも十分な機能を提供

### 6.8 GitHub

**選定理由**:
- 機能単位でのバージョン管理および履歴管理を行う
- チーム開発に適している
- CI/CDパイプラインとの連携が容易

### 6.9 Cursor / Claude Code

**選定理由**:
- 設計レビュー、コード生成、デバッグ支援に活用する
- **生成コードは必ず理解した上で使用する**

---

## 7. システム構成

### 7.1 アーキテクチャ

```
[フロントエンド]
Next.js (App Router)
├── Server Components（データ取得・getCurrentProfile, Supabase 直接取得）
├── Client Components（インタラクティブUI・フォーム・カレンダー）
└── API Routes（lessons, attendances, grades, feedback 系）

[認証・データベース]
Supabase
├── Authentication（auth.users）
├── Database（PostgreSQL）
│   ├── profiles
│   ├── students
│   ├── lessons（授業スケジュール）
│   ├── attendances
│   ├── grades
│   └── feedbacks
└── Row Level Security（RLS）

[外部サービス]
├── Google Gemini API（AIフィードバック生成）
└── Resend（メール送信）

[デプロイ]
Vercel（自動デプロイ）
```

### 7.2 データフロー

1. **ユーザー認証**: Supabase Auth でログイン。getCurrentProfile で profiles 取得。
2. **プロフィール作成**: `auth.users` の INSERT トリガー（handle_new_user）で `profiles` 自動作成。
3. **授業**: 管理者が POST /api/lessons で登録。GET /api/lessons?month= で月別一覧。教師は担当のみ。
4. **出席**: 授業詳細または生徒詳細から POST /api/attendances で upsert（student_id + lesson_date 一意）。
5. **成績**: POST /api/grades で追加。一覧は Supabase 直接取得（RLS）。
6. **フィードバック生成**: POST /api/feedback/generate（Gemini API）→ 保存は POST /api/feedback。
7. **メール送信**: POST /api/feedback/[id]/send（Resend API）→ feedbacks の sent, sent_at, send_to_email 更新。

---

## 8. 非機能要件

### 8.1 パフォーマンス

- ページ読み込み時間: 3秒以内
- API レスポンス時間: 2秒以内（Gemini API 除く）

### 8.2 セキュリティ

- 認証は Supabase Auth で実装
- RLS によるデータアクセス制御
- 環境変数による機密情報の管理
- HTTPS 通信の強制

### 8.3 可用性

- Vercel の可用性に依存（99.9%以上）

### 8.4 保守性

- TypeScript による型安全性
- ディレクトリ構成による責務の分離
- コメントによる実装意図の明示

---

## 9. 制約事項

### 9.1 技術的制約

- Supabase の無料プラン制限（RLS ポリシー数、ストレージ容量など）
- Gemini API のレート制限
- Resend の無料プラン制限（月間送信数）

### 9.2 機能的制約

- 出席は「1生徒・1日」1レコード（unique (student_id, lesson_date)）。同一日に複数授業があっても、出席は日単位で1件。
- 授業（lessons）は日時単位で複数登録可能。出席との紐づけは `lesson_at` の日付部分（YYYY-MM-DD）と `lesson_date` で対応。
- フィードバック生成は1回ずつ（バッチ処理は未対応）。

---

## 10. 今後の拡張予定

- [ ] 成績推移のグラフ表示
- [ ] フィードバック生成のストリーミング対応
- [ ] メール送信履歴の詳細表示
- [ ] エクスポート機能（CSV/PDF）
- [ ] 複数教師による共同管理機能
- [ ] モバイルアプリ化（React Native）

---

## 11. 変更履歴

### 2026年2月17日（最終版・コードベース整合）

- **DB設計に lessons テーブルを追加**（授業スケジュール。lesson_at, teacher_id, title。管理者が登録・削除、教師は担当のみ閲覧）
- **出席（attendances）と授業（lessons）の関係を明記**（出席は lesson_date で日単位。授業画面では lesson_at の日付で紐づけ）
- **feedbacks の送信先カラムを send_to_email に統一**（コード・TABLE.md 準拠）
- **API設計に lessons / attendances / grades のエンドポイントを追加**
- **画面一覧にカレンダー画面・授業詳細画面・管理者メニュー内の授業登録を追加**
- **機能一覧に授業スケジュール機能を追加**
- **ディレクトリ構成・実装済み機能を実コードに合わせて更新**
- LLM API: Gemini API、メール: Resend、プロフィール: Database Trigger、React Bootstrap、環境変数一覧は前回どおり
